#include <reg52.h>
#define DBL P0
#define SWITCH_TIME 4000 //默认1s
unsigned char a;
unsigned int pic;
bit delayflag=0;
//*********************************************
void Initial(void);
void writelcm(unsigned int x,bit R);
void Write_Command(unsigned char RegisterName);
void Write_Data(unsigned char RegisterValue);
void Field(void);
void fill(unsigned char dat1,unsigned char dat2);
void AddressSlect(unsigned char Add);
void Delay(unsigned int i);
void dummy();
//******************************************

sbit CS =P2^4;
sbit DC =P2^7;
sbit W_R =P2^6;
sbit R_D =P2^5;
sbit RES =P2^3;

sbit SCLK	 = P0^0;			// Serial Clock Input
sbit SDIN	 = P0^1;				// Serial Data Input

sbit key_stop = P1^0;//按键，按下为0暂停循环，松开为1循环跑动
sbit key_mod = P1^1;//并串模式切换按键，为0串行模式，为1为并行模式，仅在程序开机时判断

bit mod_flag = 1;

unsigned char code show[]=
{
	//-- 宽度x 高度=128x64 --*
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	//吉润电子
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x08,0x48,0x48,0x48,0x48,0x48,0x7E,0x48,0x48,0x48,0x48,0x48,0x08,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0x6C,0x0C,0x00,
	0xF6,0x06,0x20,0x24,0xE4,0x24,0x24,0x04,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0x90,0x90,0x90,0x90,0xFE,0x90,0x90,0x90,
	0x90,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,
	0x82,0x82,0x82,0x82,0x82,0xE2,0xF2,0xBA,0x9E,0x8E,0x82,0x80,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x7E,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x7E,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x38,0x1E,0x07,0x00,
	0x7F,0x00,0x08,0x09,0x0F,0x09,0x48,0x40,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x04,0x04,0x04,0x04,0x7F,0x64,0x44,0x44,
	0x44,0x47,0x70,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x40,0x40,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	//TEL:13530309438
	0x00,0x01,0x7F,0x01,0x01,0x00,0x00,0x00,0x00,0x7F,0x49,0x49,0x41,0x00,0x00,0x00,
	0x00,0x7F,0x40,0x40,0x40,0x00,0x00,0x00,0x00,0x00,0x24,0x00,0x00,0x00,0x00,0x00,
	0x00,0x42,0x7F,0x40,0x00,0x00,0x00,0x00,0x00,0x22,0x49,0x49,0x36,0x00,0x00,0x00,
	0x00,0x4F,0x49,0x49,0x31,0x00,0x00,0x00,0x00,0x22,0x49,0x49,0x36,0x00,0x00,0x00,
	0x00,0x3E,0x41,0x41,0x3E,0x00,0x00,0x00,0x00,0x22,0x49,0x49,0x36,0x00,0x00,0x00,
	0x00,0x3E,0x41,0x41,0x3E,0x00,0x00,0x00,0x00,0x26,0x49,0x49,0x3E,0x00,0x00,0x00,
	0x00,0x38,0x26,0x7F,0x20,0x00,0x00,0x00,0x00,0x22,0x49,0x49,0x36,0x00,0x00,0x00,
	0x00,0x36,0x49,0x49,0x36,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  //QQ:1903025895
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0xA2,0xC2,0xFC,0x00,0x00,0x00,
	0x00,0x7C,0xA2,0xC2,0xFC,0x00,0x00,0x00,0x00,0x00,0x48,0x00,0x00,0x00,0x00,0x00,
	0x00,0x84,0xFE,0x80,0x00,0x00,0x00,0x00,0x00,0x4C,0x92,0x92,0x7C,0x00,0x00,0x00,
	0x00,0x7C,0x82,0x82,0x7C,0x00,0x00,0x00,0x00,0x44,0x92,0x92,0x6C,0x00,0x00,0x00,
	0x00,0x7C,0x82,0x82,0x7C,0x00,0x00,0x00,0x00,0xC4,0xA2,0x92,0x8C,0x00,0x00,0x00,
	0x00,0x9E,0x92,0x92,0x62,0x00,0x00,0x00,0x00,0x6C,0x92,0x92,0x6C,0x00,0x00,0x00,
	0x00,0x4C,0x92,0x92,0x7C,0x00,0x00,0x00,0x00,0x9E,0x92,0x92,0x62,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};


void uDelay(unsigned char l)
{
	while(l--);
}

void Delay(unsigned int count)
{
	unsigned int i,j;
		for(i=0;i<count;i++)
	for(j=0;j<114;j++);
}

				// 8-bit 80XX Parallel
void Write_Command_Para(unsigned char RegisterName)
{
	CS=0;
	DC=0;
	DBL=RegisterName;
	W_R=0;
	W_R=1;
	CS=1;
}
//**************************************
void Write_Data_Para(unsigned char RegisterValue)
{
	CS=0;
	DC=1;
	DBL= (unsigned char)RegisterValue;
	W_R=0;
	W_R=1;
	CS=1;
}

				// 4-wire SPI
void Write_Command_SPI(unsigned char Data)
{
unsigned char i;

	CS=0;
	DC=0;
	for (i=0; i<8; i++)
	{
		SCLK=0;
		SDIN=(Data&0x80)>>7;
		Data = Data << 1;
	//	uDelay(1);
		SCLK=1;
	//	uDelay(1);
	}
//	SCLK=0;
	DC=1;
	CS=1;
}


void Write_Data_SPI(unsigned char Data)
{
unsigned char i;

	CS=0;
	DC=1;
	for (i=0; i<8; i++)
	{
		SCLK=0;
		SDIN=(Data&0x80)>>7;
		Data = Data << 1;
	//	uDelay(1);
		SCLK=1;
	//	uDelay(1);
	}
//	SCLK=0;
	DC=1;
	CS=1;
}

void Write_Command(unsigned char RegisterName)
{
	if(mod_flag == 1)
	{
		Write_Command_Para(RegisterName);
	}
	else
	{
		Write_Command_SPI(RegisterName);
	}
}
//**************************************
void Write_Data(unsigned char RegisterValue)
{
	if(mod_flag == 1)
	{
		Write_Data_Para(RegisterValue);
	}
	else
	{
		Write_Data_SPI(RegisterValue);
	}
}

//***********************************
void Initial(void)
{
	unsigned int x,y;
	//SSD1322IC
	Write_Command(0xFD); /*SET COMMAND LOCK*/
	Write_Data(0x12); /* UNLOCK */
	Write_Command(0xAE); /*DISPLAY OFF*/
	Write_Command(0xB3);/*DISPLAYDIVIDE CLOCKRADIO/OSCILLATAR FREQUANCY*/
	Write_Data(0x91);
	Write_Command(0xCA); /*multiplex ratio*/
	Write_Data(0x3F); /*duty = 1/64*/
	Write_Command(0xA2); /*set offset*/
	Write_Data(0x00);
	Write_Command(0xA1); /*start line*/
	Write_Data(0x00);
	Write_Command(0xA0); /*set remap*/
	Write_Data(0x14);
	Write_Data(0x11);
	/*Write_Command(0xB5); //GPIO
Write_Command(0x00); */
	Write_Command(0xAB); /*funtion selection*/
	Write_Data(0x01); /* selection external vdd */
	Write_Command(0xB4); /* */
	Write_Data(0xA0);
	Write_Data(0xfd);
	Write_Command(0xC1); /*set contrast current */
	Write_Data(0x9f);
	Write_Command(0xC7); /*master contrast current control*/
	Write_Data(0x0f);
	/* Write_Command(0xB9); GRAY TABLE*/
	Write_Command(0xB1); /*SET PHASE LENGTH*/
	Write_Data(0xE2);
	Write_Command(0xD1); /**/
	Write_Data(0x82);
	Write_Data(0x20);
	Write_Command(0xBB); /*SET PRE-CHANGE VOLTAGE*/
	Write_Data(0x1F);
	Write_Command(0xB6); /*SET SECOND PRE-CHARGE PERIOD*/
	Write_Data(0x08);
	Write_Command(0xBE); /* SET VCOMH */
	Write_Data(0x07);
	Write_Command(0xA6); /*normal display*/
	// clear();
	Write_Command(0xAF); /*display ON*/
}

void fill(unsigned char dat1,unsigned char dat2)
{
	unsigned char x,y;
	Write_Command(0x15); /*SET SECOND PRE-CHARGE PERIOD*/
	Write_Data(0x00);
	Write_Data(0x77);
	Write_Command(0x75); /*SET SECOND PRE-CHARGE PERIOD*/
	Write_Data(0x00);
	Write_Data(0x7f);
	Write_Command(0x5c);
	for(y=0;y<128;y++)
	{
		for(x=0;x<120;x++)
		Write_Data(dat1);
		Write_Data(dat2);
	}
	Delay(1);
}

void showframe(void)
{
	unsigned char x,y;
	Write_Command(0x15);
	Write_Data(0x1c);
	Write_Data(0x5b);
	Write_Command(0x75);
	Write_Data(0x00);
	Write_Data(0x3F);
	Write_Command(0x5C);
	for(x=0;x<64;x++)
	{
		Write_Data(0xFF);
		Write_Data(0xFF);
	}
	for(y=0;y<62;y++)
	{
		Write_Data(0xf0);
		Write_Data(0x00);
		for(x=0;x<62;x++)
		{
			Write_Data(0x00);
			Write_Data(0x00);
		}
		Write_Data(0x00);
		Write_Data(0x0f);
	}
	for(x=0;x<64;x++)
	{
		Write_Data(0xFF);
		Write_Data(0xFF);
	}
	Delay(1);
}

void ver()
{
	unsigned char x,y;
	Write_Command(0x15);
	Write_Data(0x1c);
	Write_Data(0x5b);
	Write_Command(0x75);
	Write_Data(0x00);
	Write_Data(0x3F);
	Write_Command(0x5C);
	for(y=0;y<64;y++)
	{
		for(x=0;x<64;x++)
		{
			Write_Data(0xf0);
			Write_Data(0xf0);
		}
	}
	Delay(1);
}

void hor()
{
	unsigned char x,y;
	Write_Command(0x15);
	Write_Data(0x1c);
	Write_Data(0x5b);
	Write_Command(0x75);
	Write_Data(0x00);
	Write_Data(0x3F);
	Write_Command(0x5C);
	for(y=0;y<32;y++)
	{
		for(x=0;x<64;x++)
		{
			Write_Data(0xff);
			Write_Data(0xff);
		}
		for(x=0;x<64;x++)
		{
			Write_Data(0x00);
			Write_Data(0x00);
		}
	}
	Delay(1);
}

void snow()
{
	unsigned char x,y;
	Write_Command(0x15);
	Write_Data(0x1c);
	Write_Data(0x5b);
	Write_Command(0x75);
	Write_Data(0x00);
	Write_Data(0x3F);
	Write_Command(0x5C);
	for(y=0;y<32;y++)
	{
		for(x=0;x<64;x++)
		{
			Write_Data(0xf0);
			Write_Data(0xf0);
		}
		for(x=0;x<64;x++)
		{
			Write_Data(0x0f);
			Write_Data(0x0f);
		}
	}
	Delay(1);
}

void clear()
{
	unsigned char x,y;
	Write_Command(0x15);
	Write_Data(0x00);
	Write_Data(0x77);
	Write_Command(0x75);
	Write_Data(0x00);
	Write_Data(0x7f);
	Write_Command(0x5C);
	for(y=0;y<128;y++)
	{
		for(x=0;x<120;x++)
		{
			Write_Data(0x00);
			Write_Data(0x00);
		}
	}
}

void Set_Column_Address(unsigned char a, unsigned char b)
{
	Write_Command(0x15);
	Write_Data(a); /* Default => 0x00*/
	Write_Data(b); /* Default => 0x77*/
}

void Set_Row_Address(unsigned char a, unsigned char b)
{
	Write_Command(0x75);
	Write_Data(a); /* Default => 0x00 */
	Write_Data(b); /* Default => 0x7F */
}

void Fill_Block(unsigned char Data, unsigned char a, unsigned char b, unsigned char c,unsigned char d)
{
	unsigned char i,j;
	Set_Column_Address(0x1C+a,0x1C+b);
	Set_Row_Address(c,d);
	Write_Command(0x5C);
	for(i=0;i<(d-c+1);i++)
	{
		for(j=0;j<(b-a+1);j++)
		{
			Write_Data(Data);
			Write_Data(Data);
		}
	}
}

void pictrue()
{
	unsigned char x,y,z;
	unsigned char value,temp_h,temp_l;
	Set_Column_Address(0x1C+0x10,0x1C+0x2F);
	Set_Row_Address(0,0x3f);
	Write_Command(0x5C);
	//x,y确定数组的位置，z确定数组的bit位数
	for(y=0;y<8;y++)
	{
		for(z=0;z<8;z++)
		{
			for(x=0;x<64;x++)
			{
				//value = ((show[y*128 + x*2] & (0x01<<z))>>z)*0x0f + ((show[y*128 + x*2+1] & (0x01<<z))>>z)*0xf0;
				temp_h = show[y*128 + x*2] & (0x01<<z);
				temp_l = show[y*128 + x*2+1] & (0x01<<z);
				if(temp_l > 0) value = 0x0f;
				else value = 0x00;
				if(temp_h > 0) value |= 0xf0;	
				
				Write_Data(value);
			}
		}
	}
}

void Grayscale()
{
	/* Level 16 => Column 1~16 */
	Fill_Block(0xFF,0x00,0x03,0x00,0x3f);
	/* Level 15 => Column 17~32*/
	Fill_Block(0xEE,0x04,0x07,0x00,0x3f);
	/* Level 14 => Column 33~48*/
	Fill_Block(0xDD,0x08,0x0B,0x00,0x3f);
	/* Level 13 => Column 49~64*/
	Fill_Block(0xCC,0x0C,0x0F,0x00,0x3f);
	/* Level 12 => Column 65~80*/
	Fill_Block(0xBB,0x10,0x13,0x00,0x3f);
	/* Level 11 => Column 81~96*/
	Fill_Block(0xAA,0x14,0x17,0x00,0x3f);
	/* Level 10 => Column 97~112*/
	Fill_Block(0x99,0x18,0x1B,0x00,0x3f);
	/* Level 9 => Column 113~128*/
	Fill_Block(0x88,0x1C,0x1F,0x00,0x3f);
	/* Level 8 => Column 129~144*/
	Fill_Block(0x77,0x20,0x23,0x00,0x3f);
	/* Level 7 => Column 145~160*/
	Fill_Block(0x66,0x24,0x27,0x00,0x3f);
	/* Level 6 => Column 161~176*/
	Fill_Block(0x55,0x28,0x2B,0x00,0x3f);
	/* Level 5 => Column 177~192*/
	Fill_Block(0x44,0x2C,0x2F,0x00,0x3f);
	/* Level 4 => Column 193~208*/
	Fill_Block(0x33,0x30,0x33,0x00,0x3f);
	/* Level 3 => Column 209~224*/
	Fill_Block(0x22,0x34,0x37,0x00,0x3f);
	/* Level 2 => Column 225~240*/
	Fill_Block(0x11,0x38,0x3B,0x00,0x3f);
	/* Level 1 => Column 241~256*/
	Fill_Block(0x00,0x3C,0x3f,0x00,0x3f);
	Delay(1);
}

//*************************************************
void main(void)
{
	TMOD=0x01;
	Delay(5);
	RES=0;
	Delay(10);
	RES=1;
	Delay(10);
	if(key_mod == 0) mod_flag = 0;//串行模式
	if(key_mod == 1) mod_flag = 1;//并行模式
	
	Initial();
//	clear();
//		Write_Command(0x15);
//	Write_Data(0x1c);
//	Write_Data(0x5b);
//	Write_Command(0x75);
//	Write_Data(0x00);
//	Write_Data(0x3F);
//	Write_Command(0x5C);
//	Write_Data(0x0f);
//	Write_Data(0xf0);
//	Write_Data(0xff);
//	Write_Data(0xff);
//	while(1);
//	
	while(1)
	{
		ver();
		Delay(SWITCH_TIME);
		while(key_stop == 0);
		//clear();
		
		hor();
		Delay(SWITCH_TIME);
		while(key_stop == 0);
		//clear();
		
		snow();
		Delay(SWITCH_TIME);
		while(key_stop == 0);
		//clear();
		
		Grayscale();
		Delay(SWITCH_TIME);
		while(key_stop == 0);
		//clear();
		
		showframe();
		Delay(SWITCH_TIME);
		while(key_stop == 0);
		clear();

		pictrue();
		Delay(SWITCH_TIME);
		while(key_stop == 0);
		//clear();
		
//		fill(0xff,0xff);
//		Delay(1000);
//		while(key_stop == 0);
//		clear();
//		Grayscale();
//		Delay(1000);
//		while(key_stop == 0);
//		clear();
//		snow();
//		Delay(20);
//		clear();
//		showframe();
//		Delay(1000);
//		while(key_stop == 0);
//		clear();
//		hor();
//		Delay(1000);
//		clear();
//		ver();
//		Delay(1000);
//		clear();
//		pictrue();
//		Delay(1000);
//		while(key_stop == 0);
	}
}
